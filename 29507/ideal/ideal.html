<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Search App</title>
    <style>
      :root {
        --bg-color: #f3f4f6;
        --text-color: #1f2937;
        --card-bg-color: #ffffff;
        --card-text-color: #4b5563;
        --button-bg-color: #e5e7eb;
        --chart-bar-color: rgba(75, 192, 192, 0.6);
        --chart-border-color: rgba(75, 192, 192, 1);
      }

      .dark-theme {
        --bg-color: #1f2937;
        --text-color: #f3f4f6;
        --card-bg-color: #374151;
        --card-text-color: #9ca3af;
        --button-bg-color: #4b5563;
        --chart-bar-color: rgba(129, 140, 248, 0.6);
        --chart-border-color: rgba(129, 140, 248, 1);
      }

      body {
        font-family: Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        transition: background-color 0.3s, color 0.3s;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      #darkModeToggle {
        background-color: var(--button-bg-color);
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        color: var(--text-color);
      }

      .search-filters {
        margin-bottom: 20px;
      }

      #searchInput {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid var(--card-text-color);
        border-radius: 5px;
        background-color: var(--card-bg-color);
        color: var(--text-color);
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }

      select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--card-text-color);
        border-radius: 5px;
        background-color: var(--card-bg-color);
        color: var(--text-color);
      }

      .chart-container,
      .comparison-section {
        margin-bottom: 20px;
      }

      .chart-wrapper {
        position: relative;
        height: 0;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
      }

      .chart-wrapper canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
      }

      .comparison-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .job-listings {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .job-card {
        background-color: var(--card-bg-color);
        color: var(--card-text-color);
        border-radius: 5px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .job-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .job-header h3 {
        margin: 0;
        font-size: 1.2em;
        color: var(--text-color);
      }

      .job-compare-checkbox {
        appearance: none;
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid var(--text-color);
        border-radius: 4px;
        outline: none;
        cursor: pointer;
        position: relative;
      }

      .job-compare-checkbox:checked {
        background-color: var(--text-color);
      }

      .job-compare-checkbox:checked::after {
        content: "\2714";
        font-size: 14px;
        color: var(--bg-color);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .loading-spinner {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
      }

      .loading-spinner div {
        box-sizing: border-box;
        display: block;
        position: absolute;
        width: 64px;
        height: 64px;
        margin: 8px;
        border: 8px solid #fff;
        border-radius: 50%;
        animation: loading-spinner 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        border-color: #fff transparent transparent transparent;
      }

      .loading-spinner div:nth-child(1) {
        animation-delay: -0.45s;
      }

      .loading-spinner div:nth-child(2) {
        animation-delay: -0.3s;
      }

      .loading-spinner div:nth-child(3) {
        animation-delay: -0.15s;
      }

      @keyframes loading-spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-overlay p {
        margin-top: 20px;
        color: #fff;
        font-size: 18px;
      }

      .not-found-message {
        text-align: center;
        font-size: 1.2em;
        color: #e53e3e;
        margin-top: 20px;
      }

      .hidden {
        display: none;
      }
      .exp-card {
        display: none;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          align-items: flex-start;
        }

        #darkModeToggle {
          margin-top: 10px;
        }

        .comparison-charts {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 10px;
        }

        h1 {
          font-size: 1.5em;
        }

        .job-card {
          padding: 10px;
        }

        .job-header h3 {
          font-size: 1em;
        }
    
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>Job Search App</h1>
        <button id="darkModeToggle">Toggle Dark Mode</button>
      </header>

      <div class="search-filters">
        <input type="text" id="searchInput" placeholder="Search jobs..." />

        <div class="filters">
          <select id="categoryFilter">
            <option value="">Filter by category</option>
          </select>
          <select id="locationFilter">
            <option value="">Filter by location</option>
          </select>
          <select id="degreeFilter">
            <option value="">Filter by degree</option>
          </select>
          <select id="experienceFilter">
            <option value="">Filter by experience</option>
          </select>
        </div>
      </div>

      <div class="chart-container">
        <h2>Jobs by Category</h2>
        <div class="chart-wrapper">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>

      <div id="comparisonSection" class="comparison-section hidden">
        <h2>Job Comparison</h2>
        <div class="comparison-charts">
          <div class="chart-wrapper">
            <canvas id="salaryChart"></canvas>
          </div>
          <div class="chart-wrapper exp-card">
            <canvas id="experienceChart"></canvas>
          </div>
        </div>
      </div>

      <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>
        <p>Loading...</p>
      </div>

      <div id="notFoundMessage" class="not-found-message hidden">
        No jobs found. Please try a different search.
      </div>

      <div id="jobListings" class="job-listings"></div>
    </div>

    <template id="jobCardTemplate">
      <div class="job-card">
        <div class="job-header">
          <h3></h3>
          <input type="checkbox" class="job-compare-checkbox" />
        </div>
        <p class="company"></p>
        <p class="location"></p>
        <p class="degree"></p>
        <p class="salary"></p>
      </div>
    </template>

    <script>
      // Global variables
      let jobs = [];
      let categories = {};
      let categoryChart, salaryChart, experienceChart;
      let selectedJobs = [];

      // DOM elements
      const darkModeToggle = document.getElementById("darkModeToggle");
      const searchInput = document.getElementById("searchInput");
      const categoryFilter = document.getElementById("categoryFilter");
      const locationFilter = document.getElementById("locationFilter");
      const degreeFilter = document.getElementById("degreeFilter");
      const experienceFilter = document.getElementById("experienceFilter");
      const jobListings = document.getElementById("jobListings");
      const jobCardTemplate = document.getElementById("jobCardTemplate");
      const comparisonSection = document.getElementById("comparisonSection");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const notFoundMessage = document.getElementById("notFoundMessage");

      // Fetch jobs from USA Jobs API
      async function fetchJobs() {
        const apiKey = "ej7+P6nlAqo7hb8/vYaz8MI9xDu9F73WC0D5NRKIZaU="; // Replace with your actual API key

        try {
          showLoading(true);
          const response = await fetch("https://data.usajobs.gov/api/search", {
            headers: {
              "Authorization-Key": apiKey,

              Host: "data.usajobs.gov",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          jobs = data.SearchResult.SearchResultItems;

          if (!jobs || jobs.length === 0) {
            showNotFound(true);
          } else {
            showNotFound(false);
            updateCategories();
            populateFilters();
            renderJobs(jobs);
            await renderCategoryChart();
          }
        } catch (error) {
          handleError(error, "Error loading jobs. Please try again later.");
        } finally {
          showLoading(false);
        }
      }

      function showLoading(show) {
        loadingOverlay.classList.toggle("hidden", !show);
      }

      function showNotFound(show) {
        notFoundMessage.classList.toggle("hidden", !show);
        jobListings.classList.toggle("hidden", show);
      }

      // Update categories based on job data
      function updateCategories() {
        categories = jobs.reduce((acc, job) => {
          const category = job.MatchedObjectDescriptor.JobCategory[0].Name;
          acc[category] = (acc[category] || 0) + 1;
          return acc;
        }, {});
      }

      // Populate filter dropdowns
      function populateFilters() {
        const uniqueCategories = [
          ...new Set(
            jobs.map((job) => job.MatchedObjectDescriptor.JobCategory[0].Name)
          ),
        ];
        const uniqueLocations = [
          ...new Set(
            jobs.map(
              (job) =>
                job.MatchedObjectDescriptor.PositionLocation[0].LocationName
            )
          ),
        ];
        const uniqueDegrees = [
          ...new Set(
            jobs.map((job) => job.MatchedObjectDescriptor.MinimumEducation)
          ),
        ];
        const uniqueExperiences = [
          ...new Set(
            jobs.flatMap((job) => {
              const qualifications =
                job.MatchedObjectDescriptor.QualificationSummary.toLowerCase();
              const experienceMatch =
                qualifications.match(/(\d+)\s*(year|years)/);
              return experienceMatch
                ? [`${experienceMatch[1]} ${experienceMatch[2]}`]
                : [];
            })
          ),
        ];

        populateSelect(categoryFilter, uniqueCategories);
        populateSelect(locationFilter, uniqueLocations);
        populateSelect(degreeFilter, uniqueDegrees);
        populateSelect(experienceFilter, uniqueExperiences);
      }

      function populateSelect(selectElement, options) {
        selectElement.innerHTML = '<option value="">All</option>';
        options.forEach((option) => {
          const optionElement = document.createElement("option");
          optionElement.value = option;
          optionElement.textContent = option;
          selectElement.appendChild(optionElement);
        });
      }

      // Render job listings
      function renderJobs(jobsToRender) {
        jobListings.innerHTML = "";

        if (jobsToRender.length === 0) {
          showNotFound(true);
        } else {
          showNotFound(false);
          jobsToRender.forEach((job) => {
            const jobCard = jobCardTemplate.content.cloneNode(true);
            const jobData = job.MatchedObjectDescriptor;

            jobCard.querySelector("h3").textContent = jobData.PositionTitle;
            jobCard.querySelector(".company").textContent =
              jobData.OrganizationName;
            jobCard.querySelector(".location").textContent =
              jobData.PositionLocation[0].LocationName;
            jobCard.querySelector(".degree").textContent = `Required Degree: ${
              jobData.MinimumEducation || "N/A"
            }`;
            const minSalary = parseSalary(
              jobData.PositionRemuneration[0].MinimumRange
            );
            const maxSalary = parseSalary(
              jobData.PositionRemuneration[0].MaximumRange
            );
            jobCard.querySelector(
              ".salary"
            ).textContent = `Salary Range: ${formatSalary(
              minSalary
            )} - ${formatSalary(maxSalary)}`;

            const checkbox = jobCard.querySelector(".job-compare-checkbox");
            checkbox.dataset.jobId = job.MatchedObjectId;
            checkbox.addEventListener("change", handleJobSelection);

            jobListings.appendChild(jobCard);
          });
        }
      }

      function createChart(ctx, type, data, options) {
        return new Chart(ctx, {
          type: type,
          data: data,
          options: {
            ...options,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              ...options.plugins,
              legend: {
                ...options.plugins?.legend,
                labels: {
                  ...options.plugins?.legend?.labels,
                  color: getComputedStyle(document.body).getPropertyValue(
                    "--text-color"
                  ),
                },
              },
            },
            scales: {
              ...options.scales,
              x: {
                ...options.scales?.x,
                ticks: {
                  ...options.scales?.x?.ticks,
                  color: getComputedStyle(document.body).getPropertyValue(
                    "--text-color"
                  ),
                },
                grid: {
                  ...options.scales?.x?.grid,
                  color: getComputedStyle(document.body).getPropertyValue(
                    "--card-text-color"
                  ),
                },
              },
              y: {
                ...options.scales?.y,
                ticks: {
                  ...options.scales?.y?.ticks,
                  color: getComputedStyle(document.body).getPropertyValue(
                    "--text-color"
                  ),
                },
                grid: {
                  ...options.scales?.y?.grid,
                  color: getComputedStyle(document.body).getPropertyValue(
                    "--card-text-color"
                  ),
                },
              },
            },
          },
        });
      }

      async function renderCategoryChart() {
        showLoading(true);
        const ctx = document.getElementById("categoryChart").getContext("2d");
        if (categoryChart) {
          categoryChart.destroy();
        }
        return new Promise((resolve) => {
          categoryChart = createChart(
            ctx,
            "bar",
            {
              labels: Object.keys(categories),
              datasets: [
                {
                  label: "Number of Jobs",
                  data: Object.values(categories),
                  backgroundColor: getComputedStyle(
                    document.body
                  ).getPropertyValue("--chart-bar-color"),
                  borderColor: getComputedStyle(document.body).getPropertyValue(
                    "--chart-border-color"
                  ),
                  borderWidth: 1,
                },
              ],
            },
            {
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
              onClick: (event, elements) => {
                if (elements.length > 0) {
                  const index = elements[0].index;
                  const category = Object.keys(categories)[index];
                  categoryFilter.value = category;
                  applyFilters();
                }
              },
              animation: {
                onComplete: () => {
                  showLoading(false);
                  resolve();
                },
              },
            }
          );
        });
      }

      function renderSalaryChart() {
        const ctx = document.getElementById("salaryChart").getContext("2d");
        if (salaryChart) {
          salaryChart.destroy();
        }
        salaryChart = createChart(
          ctx,
          "bar",
          {
            labels: selectedJobs.map(
              (job) => job.MatchedObjectDescriptor.PositionTitle
            ),
            datasets: [
              {
                label: "Minimum Salary",
                data: selectedJobs.map((job) =>
                  parseFloat(
                    job.MatchedObjectDescriptor.PositionRemuneration[0]
                      .MinimumRange
                  )
                ),
                backgroundColor: getComputedStyle(
                  document.body
                ).getPropertyValue("--chart-bar-color"),
              },
              {
                label: "Maximum Salary",
                data: selectedJobs.map((job) =>
                  parseFloat(
                    job.MatchedObjectDescriptor.PositionRemuneration[0]
                      .MaximumRange
                  )
                ),
                backgroundColor: getComputedStyle(
                  document.body
                ).getPropertyValue("--chart-border-color"),
              },
            ],
          },
          {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Salary (USD)",
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "Salary Comparison",
              },
            },
          }
        );
      }

      function renderExperienceChart() {
        const ctx = document.getElementById("experienceChart").getContext("2d");
        if (experienceChart) {
          experienceChart.destroy();
        }

        const getExperienceYears = (job) => {
          const qualifications =
            job.MatchedObjectDescriptor.QualificationSummary.toLowerCase();
          const experienceMatch = qualifications.match(/(\d+)\s*(year|years)/);
          return experienceMatch ? parseInt(experienceMatch[1]) : 0;
        };

        experienceChart = createChart(
          ctx,
          "bar",
          {
            labels: selectedJobs.map(
              (job) => job.MatchedObjectDescriptor.PositionTitle
            ),
            datasets: [
              {
                label: "Years of Experience",
                data: selectedJobs.map(getExperienceYears),
                backgroundColor: getComputedStyle(
                  document.body
                ).getPropertyValue("--chart-bar-color"),
              },
            ],
          },
          {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Years of Experience",
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "Experience Comparison",
              },
            },
          }
        );
      }

      async function applyFilters() {
        showLoading(true);
        const searchTerm = searchInput.value.toLowerCase();
        const category = categoryFilter.value;
        const location = locationFilter.value;
        const degree = degreeFilter.value;
        const experience = experienceFilter.value;

        const filteredJobs = jobs.filter((job) => {
          const jobData = job.MatchedObjectDescriptor;
          const jobExperience =
            jobData.QualificationSummary.toLowerCase().match(
              /(\d+)\s*(year|years)/
            );

          return (
            jobData.PositionTitle.toLowerCase().includes(searchTerm) &&
            (category === "" || jobData.JobCategory[0].Name === category) &&
            (location === "" ||
              jobData.PositionLocation[0].LocationName === location) &&
            (degree === "" || jobData.MinimumEducation === degree) &&
            (experience === "" ||
              (jobExperience && jobExperience[0] === experience))
          );
        });

        clearComparison();
        renderJobs(filteredJobs);
        await updateCategoryChart(filteredJobs);
        showLoading(false);
      }

      async function updateCategoryChart(filteredJobs) {
        const filteredCategories = filteredJobs.reduce((acc, job) => {
          const category = job.MatchedObjectDescriptor.JobCategory[0].Name;
          acc[category] = (acc[category] || 0) + 1;
          return acc;
        }, {});

        categoryChart.data.labels = Object.keys(filteredCategories);
        categoryChart.data.datasets[0].data = Object.values(filteredCategories);
        await new Promise((resolve) => {
          categoryChart.update();
          categoryChart.options.animation.onComplete = () => {
            resolve();
          };
        });
      }

      function handleJobSelection(event) {
        const jobId = event.target.dataset.jobId;
        const job = jobs.find((j) => j.MatchedObjectId === jobId);

        if (event.target.checked) {
          if (selectedJobs.length < 2) {
            selectedJobs.push(job);
          } else {
            event.target.checked = false;
            alert("You can only compare up to 2 jobs at a time.");
          }
        } else {
          selectedJobs = selectedJobs.filter(
            (j) => j.MatchedObjectId !== jobId
          );
        }

        if (selectedJobs.length === 2) {
          renderComparisonCharts();
          comparisonSection.classList.remove("hidden");
        } else {
          comparisonSection.classList.add("hidden");
        }
      }

      function renderComparisonCharts() {
        renderSalaryChart();
        renderExperienceChart();
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark-theme");
        updateChartsTheme();
        localStorage.setItem(
          "darkMode",
          document.body.classList.contains("dark-theme") ? "dark" : "light"
        );
      }

      function updateChartsTheme() {
        [categoryChart, salaryChart, experienceChart].forEach((chart) => {
          if (chart) {
            chart.options.plugins.legend.labels.color = getComputedStyle(
              document.body
            ).getPropertyValue("--text-color");
            chart.options.scales.x.ticks.color = getComputedStyle(
              document.body
            ).getPropertyValue("--text-color");
            chart.options.scales.x.grid.color = getComputedStyle(
              document.body
            ).getPropertyValue("--card-text-color");
            chart.options.scales.y.ticks.color = getComputedStyle(
              document.body
            ).getPropertyValue("--text-color");
            chart.options.scales.y.grid.color = getComputedStyle(
              document.body
            ).getPropertyValue("--card-text-color");
            chart.data.datasets.forEach((dataset) => {
              dataset.backgroundColor = getComputedStyle(
                document.body
              ).getPropertyValue("--chart-bar-color");
              dataset.borderColor = getComputedStyle(
                document.body
              ).getPropertyValue("--chart-border-color");
            });
            chart.update();
          }
        });
      }

      function initDarkMode() {
        const darkModePreference = localStorage.getItem("darkMode");
        if (darkModePreference === "dark") {
          document.body.classList.add("dark-theme");
        }
      }

      function parseSalary(salaryString) {
        return parseFloat(salaryString.replace(/[^0-9.]/g, ""));
      }

      function formatSalary(salary) {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
        }).format(salary);
      }

      function debounce(func, delay) {
        let debounceTimer;
        return function () {
          const context = this;
          const args = arguments;
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => func.apply(context, args), delay);
        };
      }

      function clearComparison() {
        selectedJobs = [];
        comparisonSection.classList.add("hidden");
        document
          .querySelectorAll(".job-compare-checkbox")
          .forEach((checkbox) => {
            checkbox.checked = false;
          });
      }

      function handleError(error, message) {
        console.error(error);
        jobListings.innerHTML = `<p class="error-message">${message}</p>`;
        showLoading(false);
      }

      // Event listeners
      darkModeToggle.addEventListener("click", toggleDarkMode);
      searchInput.addEventListener("input", debounce(applyFilters, 300));
      categoryFilter.addEventListener("change", applyFilters);
      locationFilter.addEventListener("change", applyFilters);
      degreeFilter.addEventListener("change", applyFilters);
      experienceFilter.addEventListener("change", applyFilters);

      // Initialize app
      function initApp() {
        initDarkMode();
        fetchJobs();
      }

      // Call initApp when the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
